// src/lib/modeSignals.js
// í…ìŠ¤íŠ¸ â†’ 7ê°œì˜ ì‹ í˜¸ ë²¡í„°ë¡œ ë³€í™˜


// 1) í…ìŠ¤íŠ¸ ì •ë¦¬ í—¬í¼ (ê³µí†µ)
function clean(text) {
  return String(text ?? "")
    .trim()
    .toLowerCase()
    .replace(/[.,!?â€¦]/g, " ")
    .replace(/\s+/g, " ");
}

export function extractSignals(text) {
  const t = (text ?? "").trim();
  const has = (w) => t.includes(w);

  // ê¸°ë³¸ê°’ 0ìœ¼ë¡œ ì´ˆê¸°í™”ëœ ì‹ í˜¸ ë²¡í„°
  const s = {
    emotion_vs_logic: 0,        // ê°ì • â†” ì´ì„± ê°ˆë“± / ê°ì • ê°•ë„
    risk_avoidance: 0,          // ë¦¬ìŠ¤í¬/ì‹¤íŒ¨ íšŒí”¼
    responsibility_avoidance: 0,// ì±…ì„/ì˜ë¬´ íšŒí”¼
    analysis_paralysis: 0,      // ë¨¸ë¦¬ë¡œë§Œ, ê³¼ë¶„ì„/ë§ˆë¹„
    priority_confusion: 0,      // ìš°ì„ ìˆœìœ„ í˜¼ë€
    energy_level: 0,            // ì—ë„ˆì§€/í™œë ¥
    novelty_drive: 0,           // ìƒˆë¡œì›€/íƒìƒ‰ ìš•êµ¬
  };

  // -------------------------------------------------
  // DELAY : ë§ˆë¹„/í˜¼ë€/ë¯¸ë£¨ê¸°
  // -------------------------------------------------
  if (
    has("ë©í•˜ë‹ˆ") ||
    has("ë©í•˜ê²Œ") ||
    has("ì†ì— ì•ˆ ì¡íŒë‹¤") ||
    has("ì•„ë¬´ê²ƒë„ ì†ì— ì•ˆ ì¡íŒë‹¤") ||
    has("ì•„ë¬´ ì˜ìš•ì´ ì—†ë‹¤") ||
    has("ê·¸ëƒ¥ ì‰¬ê³  ì‹¶ë‹¤") ||
    has("ê·¸ëƒ¥ ëˆ„ì›Œ") ||
    has("ì¹¨ëŒ€ì— ëˆ„ì›Œ") ||
    has("ë¯¸ë£¨ê³  ì‹¶ë‹¤")
  ) {
    s.analysis_paralysis = Math.max(s.analysis_paralysis, 3);
  }

  // âœ… ë¬´ê¸°ë ¥/í”¼ê³¤/ëˆ„ì›Œìˆê³  ì‹¶ë‹¤ = DELAY ê°•ì‹ í˜¸
  if (
    has("í”¼ê³¤") ||
    has("ì§€ì³") ||
    has("ì˜ìš•ì´ ì—†ë‹¤") ||
    has("ì•„ë¬´ ì˜ìš•ì´ ì—†ë‹¤") ||
    has("ê·€ì°®") ||
    has("ëˆ„ì›Œ") ||
    has("ì¹¨ëŒ€") ||
    has("ê·¸ëƒ¥ ì‰¬ê³  ì‹¶ë‹¤") ||
    has("ì‰¬ê³  ì‹¶ë‹¤")
  ) {
    s.energy_level = 0; // í™•ì •
    s.analysis_paralysis = Math.max(s.analysis_paralysis, 2);
    s.responsibility_avoidance = Math.max(s.responsibility_avoidance, 2);
  }
  

  if (
    has("ë­˜ ë¨¼ì € í•´ì•¼ í• ì§€") ||
    has("ìš°ì„ ìˆœìœ„") ||
    has("ë­˜ í¬ê¸°í•´ì•¼ í• ì§€ë„") ||
    has("ë­˜ í•´ì•¼ í• ì§€ ëª¨ë¥´ê² ë‹¤") ||
    has("ëª©ë¡ì´ ë„ˆë¬´ ê¸¸ì–´ì„œ")
  ) {
    s.priority_confusion = Math.max(s.priority_confusion, 3);
  }

  if (has("ê°ì •") || has("ë§ˆìŒì´") || has("ê¸°ë¶„ì´") || has("ë¨¸ë¦¿ì†ì´ ë„ˆë¬´ ë³µì¡")) {
    s.emotion_vs_logic = Math.max(s.emotion_vs_logic, 3);
  }

  if (has("ê·€ì°®ë‹¤") || has("ì§€ì³ì„œ") || has("í”¼ê³¤í•´ì„œ")) {
    s.energy_level = Math.max(s.energy_level, 0); // ì—ë„ˆì§€ ê±°ì˜ 0ìœ¼ë¡œ ë³´ëŠ” íŒ¨í„´
  }

  if (has("ë„·í”Œë¦­ìŠ¤") || has("ê²Œì„") || has("ë”´ì§“") || has("ë”´ ìƒê°")) {
    s.responsibility_avoidance = Math.max(s.responsibility_avoidance, 3);
  }

  // -------------------------------------------------
  // STABILIZE : ë¦¬ë“¬/ì»¨ë””ì…˜/ë£¨í‹´ íšŒë³µ
  // -------------------------------------------------
  if (
    has("ìƒí™œ ë¦¬ë“¬") ||
    has("ë¦¬ë“¬ì„ ë‹¤ì‹œ ì¡ê³ ") ||
    has("ë¦¬ë“¬ì„ ë‹¤ì‹œ") ||
    has("ê¸°ë³¸ ë£¨í‹´") ||
    has("ë£¨í‹´ì„") ||
    has("ë£¨í‹´ì„ ìœ ì§€") ||
    has("ì»¨ë””ì…˜ì„ íšŒë³µ") ||
    has("ì»¨ë””ì…˜ íšŒë³µ") ||
    has("íšŒë³µí•˜ê³  ì‹¶ë‹¤") ||
    has("íšŒë³µí•´ì•¼ê² ë‹¤") ||
    has("ë¬´ë¦¬í•˜ì§€ ì•Šê³ ") ||
    has("ì•ˆì •ì ìœ¼ë¡œ") ||
    has("ìœ ì§€í•˜ëŠ” ë°") ||
    has("ìœ ì§€ì— ì§‘ì¤‘") ||
    has("ì²´ë ¥ê³¼ ë§ˆìŒ ìƒíƒœë¥¼ ì•ˆì •") ||
    has("ì•ˆì •ì‹œí‚¤ëŠ” ê²Œ ë¨¼ì €")
  ) {
    // â€œê¸°ì´ˆ ì²´ë ¥/ì•ˆì •â€ì— ê°€ê¹ê²Œ ì‹ í˜¸ ì„¸íŒ…
    s.risk_avoidance = Math.max(s.risk_avoidance, 1);      // ë¬´ë¦¬/ë¦¬ìŠ¤í¬ í”¼í•˜ê³  ì‹¶ìŒ
    s.emotion_vs_logic = Math.max(s.emotion_vs_logic, 1);  // ì»¨ë””ì…˜/ê°ì • ì˜ì‹
    s.energy_level = Math.max(s.energy_level, 1);          // ì•„ì£¼ 0ì€ ì•„ë‹˜, íšŒë³µ ì˜ì§€
  }

 // -------------------------------------------------
// REFLECT : ë‚´ë©´ ê´€ì°°/ë˜ëŒì•„ë³´ê¸°
// -------------------------------------------------
const reflectHits =
  has("ë˜ëŒì•„ë³´") ||
  has("ëŒì•„ë³´ë‹ˆ") ||
  has("ëŒì•„ë³´") ||
  has("ë˜ì§š") ||
  has("ê³±ì”¹") ||
  has("ê³±ì”¹ì–´ë³´ë‹ˆ") ||
  has("ìƒê°í•´ë³´ë‹ˆ") ||
  has("ì´í•´í•´ë³´ê³  ì‹¶") ||
  has("ì´ìœ ë¥¼ ì°¾ê³  ì‹¶ë‹¤") ||
  has("ì´ìœ ë¥¼") ||
  has("ì´ìœ ë¥¼ ì°¾") ||
  has("ì™œ ì´ëŸ°") ||
  has("ì™œ ì´ë ‡ê²Œ") ||
  has("ì›ì¸ì„ ë¶„ì„í•´ë³´ê³  ì‹¶ë‹¤") ||
  has("ê¸°ì¤€ì„ ë‹¤ì‹œ") ||
  has("ê¸°ì¤€ì„ ì„¸ì›Œë³´ê³  ì‹¶ë‹¤") ||
  has("íŒ¨í„´ì´ ë³´ì¸ë‹¤") ||
  has("ë” ê¹Šê²Œ ìƒê°í•´ë³´ê³  ì‹¶ë‹¤") ||
  has("ë‚´ ê°ì •ì„") ||
  has("ë‚´ ë§ˆìŒì´ ì™œ") ||
  has("ë‚´ë©´ ê´€ì°°") ||
  has("ë“¤ì—¬ë‹¤ë³´ê³ ") ||
  has("ë¶ˆí¸í•˜ê²Œ ê±¸ë¦¬ëŠ”") ||
  has("ì„ íƒì´ ì˜³ì•˜ëŠ”ì§€");

if (reflectHits) {
  s.emotion_vs_logic = Math.max(s.emotion_vs_logic, 3);
  s.analysis_paralysis = Math.max(s.analysis_paralysis, 2);
}



  // -------------------------------------------------
  // SIMPLIFY : ë‹¨ìˆœí™”/ìµœì†Œí™”/í•µì‹¬ë§Œ
  // -------------------------------------------------
  if (
    has("ë‹¨ìˆœí•˜ê²Œ") ||
    has("ë‹¨ìˆœí™”") ||
    has("ì„ íƒì„ ì¤„ì—¬") ||
    has("í•µì‹¬ë§Œ") ||
    has("ë¶ˆí•„ìš”í•œ ì¼ì •ë“¤ì„ ì •ë¦¬") ||
    has("ë¶ˆí•„ìš”í•œ ì¼ì •ë“¤ì„") ||
    has("ëª©ë¡ì„ ìµœì†Œí™”") ||
    has("ëª©ë¡ì„ ìµœì†Œí™”í•´ì„œ") ||
    has("ì„¸ ì¤„ë¡œ ì••ì¶•") ||
    has("ì„¸ ì¤„ê¹Œì§€ë§Œ") ||
    has("3ê°œ ì´í•˜ë¡œ ìœ ì§€") ||
    has("ì„¸ ê°œë§Œ ë‚¨ê¸°ê³ ") ||
    has("ë¯¸ë‹ˆë©€í•˜ê²Œ ì •ë¦¬í•˜ê³  ì‹¶ë‹¤") ||
    has("í•´ì•¼ í•˜ëŠ” ê²ƒë§Œ ê³ ë¥´ê³ ")
  ) {
    // ìš°ì„ ìˆœìœ„ë¥¼ ì¤„ì´ê³  í•µì‹¬ë§Œ ê³ ë¥´ë ¤ëŠ” ìƒíƒœ
    s.priority_confusion = Math.max(s.priority_confusion, 2);
    s.analysis_paralysis = Math.max(s.analysis_paralysis, 1);
  }

  // -------------------------------------------------
  // DECISIVE : ê²°ë‹¨/ì‹¤í–‰/ì˜¤ëŠ˜ ì•ˆì— ëë‚¸ë‹¤
  // -------------------------------------------------
  if (
    has("ê²°ì‹¬í–ˆë‹¤") ||
    has("ëë‚´ê¸°ë¡œ ë§ˆìŒë¨¹ì—ˆë‹¤") ||
    has("ë¬´ì¡°ê±´ ëë‚¼") ||
    has("ë°˜ë“œì‹œ ë§Œë“¤ì–´ë‚¸ë‹¤") ||
    has("ì˜¤ëŠ˜ ì•ˆì—") && (has("ëë‚¼") || has("í•´ë‚¼ ìˆ˜ ìˆì„ ê²ƒ ê°™ë‹¤")) ||
    has("ë” ìƒê°í•  ì‹œê°„ ì—†ì´") ||
    has("ë°”ë¡œ í–‰ë™í•´ì•¼ê² ë‹¤") ||
    has("ì§€ê¸ˆ ë°”ë¡œ ì‹œì‘í•˜ë©´") ||
    has("ì§€ê¸ˆ í•„ ë°›ì•˜ë‹¤") ||
    has("ëê¹Œì§€ ê°€ë©´ ë¼")
  ) {
    s.energy_level = Math.max(s.energy_level, 3);
    s.analysis_paralysis = Math.max(s.analysis_paralysis, 0);
  }

  // -------------------------------------------------
  // EXPLORATORY : íƒìƒ‰/ì‹¤í—˜/ìƒˆë¡œì›€/í˜¸ê¸°ì‹¬
  // -------------------------------------------------
  if (
    has("ìƒˆë¡œìš´ ê±¸") ||
    has("ìƒˆë¡œìš´ ê±¸ ë°°ìš°ê³  ì‹¶ë‹¤") ||
    has("ìƒˆë¡œìš´ ë°©ë²•") ||
    has("ë‹¤ë¥¸ ê´€ì ìœ¼ë¡œ ì ‘ê·¼") ||
    has("ì™„ì „íˆ ë‹¤ë¥¸ ê´€ì ") ||
    has("ì‹¤í—˜í•´ë³´ê³  ì‹¶ë‹¤") ||
    has("ì´ê²ƒì €ê²ƒ ì‹¤í—˜") ||
    has("íƒìƒ‰í•˜ëŠ” ì¤‘ì´ë‹¤") ||
    has("ììœ ë¡­ê²Œ íƒìƒ‰") ||
    has("í˜¸ê¸°ì‹¬ì´ ìƒê²¨ì„œ") ||
    has("ì°½ì˜ë ¥ì´ ìƒ˜ì†ŸëŠ”") ||
    has("ì°½ì˜ì ì¸ ì˜ê°ì´") ||
    has("ì•ˆ í•´ë³´ë˜ ë°©ì‹") ||
    has("ë‚¨ë“¤ì´ ì•ˆ í•˜ëŠ” ì§“") ||
    has("ì•„ì´ë””ì–´ê°€ ê³„ì† ë– ì˜¤ë¥¸ë‹¤")
  ) {
    s.novelty_drive = Math.max(s.novelty_drive, 3);
    s.energy_level = Math.max(s.energy_level, 3);
  }

  // ---------------------------------------
  // ğŸ”¹ ê³¨ë“œìƒ˜í”Œ íŠ¹ìˆ˜ ì¼€ì´ìŠ¤ íŠœë‹
  // ---------------------------------------
  const textNorm = clean(text);
  const textNoSpace = textNorm.replace(/\s/g, "");

  // 1) "ì¼ë‹¨ ì˜¤ëŠ˜ì€ ë²„í‹°ëŠ” ê²Œ ì „ë¶€ë‹¤."
  if (textNoSpace.includes("ë²„í‹°ëŠ”ê²Œì „ë¶€ë‹¤")) {
    s.energy_level = Math.max(s.energy_level, 0);
    s.emotion_vs_logic = Math.max(s.emotion_vs_logic, 1);
    s.risk_avoidance = Math.max(s.risk_avoidance, 1);
  }

  // 2) "ì´ë²ˆ ì£¼ëŠ” ê²°ê³¼ë¬¼ì„ ë°˜ë“œì‹œ ë§Œë“¤ì–´ë‚¸ë‹¤."
  if (textNoSpace.includes("ê²°ê³¼ë¬¼ì„ë°˜ë“œì‹œë§Œë“¤ì–´ë‚¸ë‹¤")) {
    s.energy_level = Math.max(s.energy_level, 2);
    s.analysis_paralysis = Math.min(s.analysis_paralysis, 1);
  }


  return s;
}